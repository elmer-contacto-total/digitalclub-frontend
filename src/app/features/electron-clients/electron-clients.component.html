<!-- Electron Clients Component -->
<!-- CRM Panel for use alongside WhatsApp Web in Electron -->

<div class="electron-clients-container">
  <!-- Not in Electron Warning -->
  @if (!isElectron()) {
    <div class="not-electron-warning">
      <div class="warning-content">
        <i class="ph ph-desktop"></i>
        <h2>Aplicacion de Escritorio Requerida</h2>
        <p>Esta seccion esta disenada para funcionar con la aplicacion de escritorio Electron.</p>
        <p class="hint">Descarga la aplicacion de escritorio para usar esta funcionalidad junto con WhatsApp Web.</p>
      </div>
    </div>
  } @else {
    <!-- Main Content -->
    <div class="crm-panel">
      <!-- Header -->
      <div class="panel-header">
        <div class="header-content">
          <i class="ph ph-address-book"></i>
          <span>Panel CRM</span>
        </div>
      </div>

      <!-- Empty State -->
      @if (viewState() === 'empty') {
        <div class="empty-state">
          <div class="empty-content">
            <div class="empty-icon">
              <i class="ph ph-chats-circle"></i>
            </div>
            <h3>Sin contacto seleccionado</h3>
            <p>Selecciona un chat en WhatsApp para ver la informacion del contacto</p>
            <div class="empty-tip">
              <i class="ph ph-lightbulb"></i>
              <span>El numero se detecta automaticamente del chat de WhatsApp</span>
            </div>
          </div>
        </div>
      }

      <!-- Loading State -->
      @if (viewState() === 'loading') {
        <div class="loading-state">
          <div class="spinner"></div>
          <span>Buscando contacto...</span>
        </div>
      }

      <!-- Contact Info -->
      @if (viewState() === 'contact') {
        <div class="contact-info">
          <!-- Contact Card -->
          <div class="contact-card">
            <div class="contact-avatar">
              @if (getAvatarUrl()) {
                <img [src]="getAvatarUrl()" alt="Avatar" class="avatar-img" />
              } @else {
                <div class="avatar-placeholder" [class.registered]="isRegistered()">
                  {{ initials() }}
                </div>
              }
              @if (isRegistered()) {
                <div class="status-indicator registered" title="Cliente Registrado">
                  <i class="ph ph-check"></i>
                </div>
              }
            </div>
            <div class="contact-main">
              <h2 class="contact-name">{{ displayName() }}</h2>
              <div class="contact-phone">
                <i class="ph ph-phone"></i>
                <span>{{ displayPhone() }}</span>
              </div>
            </div>
            <div class="contact-type">
              @if (isRegistered()) {
                <span class="type-badge registered">
                  <i class="ph ph-user-check"></i>
                  Cliente
                </span>
              } @else {
                <span class="type-badge personal">
                  <i class="ph ph-user"></i>
                  Personal
                </span>
              }
            </div>
          </div>

          <!-- Scrollable Content -->
          <div class="scrollable-content">
            <!-- Registered Contact Info -->
            @if (isRegistered()) {
              <!-- Client Details -->
              <div class="section">
                <div class="section-header">
                  <i class="ph ph-identification-card"></i>
                  <span>Datos del Cliente</span>
                </div>
                <div class="details-grid">
                  @if (getCodigo()) {
                    <div class="detail-item">
                      <span class="detail-label">Codigo</span>
                      <span class="detail-value">{{ getCodigo() }}</span>
                    </div>
                  }
                  @if (getEmail()) {
                    <div class="detail-item">
                      <span class="detail-label">Email</span>
                      <span class="detail-value">{{ getEmail() }}</span>
                    </div>
                  }
                  @if (getManagerName()) {
                    <div class="detail-item">
                      <span class="detail-label">Agente</span>
                      <span class="detail-value">{{ getManagerName() }}</span>
                    </div>
                  }
                  @if (contact()?.registered?.createdAt) {
                    <div class="detail-item">
                      <span class="detail-label">Cliente desde</span>
                      <span class="detail-value">{{ formatDate(contact()?.registered?.createdAt) }}</span>
                    </div>
                  }
                </div>

                @if (hasOpenTicket()) {
                  <div class="ticket-badge">
                    <i class="ph ph-ticket"></i>
                    <span>Caso abierto</span>
                  </div>
                }
              </div>

              <!-- Custom Fields -->
              @if (hasCustomFields()) {
                <div class="section">
                  <div class="section-header">
                    <i class="ph ph-database"></i>
                    <span>Datos Adicionales</span>
                  </div>
                  <div class="custom-fields">
                    @for (entry of getCustomFieldsEntries(); track entry.key) {
                      <div class="field-item">
                        <span class="field-label">{{ formatFieldLabel(entry.key) }}</span>
                        <span class="field-value">{{ formatFieldValue(entry.value) }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Quick Replies -->
              <div class="section">
                <div class="section-header">
                  <i class="ph ph-lightning"></i>
                  <span>Respuestas Rapidas</span>
                </div>
                @if (!showCannedMessages()) {
                  <button
                    class="action-btn"
                    [disabled]="loadingCannedMessages()"
                    (click)="loadCannedMessages()"
                  >
                    @if (loadingCannedMessages()) {
                      <span class="spinner-sm"></span>
                      <span>Cargando...</span>
                    } @else {
                      <i class="ph ph-chat-text"></i>
                      <span>Ver mensajes predefinidos</span>
                    }
                  </button>
                } @else {
                  <div class="dropdown-panel">
                    <div class="dropdown-header">
                      <span>Selecciona un mensaje</span>
                      <button class="close-btn" (click)="closeCannedMessages()">
                        <i class="ph ph-x"></i>
                      </button>
                    </div>
                    <div class="dropdown-content">
                      @for (msg of cannedMessages(); track msg.id) {
                        <button class="dropdown-item" (click)="onCannedMessageSelect(msg)">
                          {{ msg.message }}
                        </button>
                      }
                      @if (cannedMessages().length === 0) {
                        <div class="dropdown-empty">No hay mensajes disponibles</div>
                      }
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Personal Label (for non-registered contacts) -->
            @if (!isRegistered()) {
              <div class="section">
                <div class="section-header">
                  <i class="ph ph-tag"></i>
                  <span>Etiqueta</span>
                </div>
                <div class="label-chips">
                  @for (option of labelOptions; track option.value) {
                    <button
                      class="label-chip"
                      [class.selected]="selectedLabel() === option.value"
                      (click)="onLabelChange(option.value)"
                    >
                      <i [class]="option.icon"></i>
                      <span>{{ option.label }}</span>
                    </button>
                  }
                </div>
                @if (selectedLabel()) {
                  <button class="clear-label-btn" (click)="onLabelChange('')">
                    <i class="ph ph-x"></i>
                    <span>Quitar etiqueta</span>
                  </button>
                }
              </div>
            }

            <!-- Notes Section -->
            <div class="section">
              <div class="section-header">
                <i class="ph ph-note-pencil"></i>
                <span>{{ isRegistered() ? 'Notas del Cliente' : 'Notas Personales' }}</span>
              </div>
              <textarea
                class="notes-input"
                [ngModel]="notesField()"
                (ngModelChange)="notesField.set($event)"
                (blur)="saveNotes()"
                placeholder="Escribe notas sobre este contacto..."
                rows="3"
              ></textarea>
            </div>

            <!-- Action Buttons (for registered contacts) -->
            @if (isRegistered()) {
              <div class="section actions-section">
                @if (!hasOpenTicket()) {
                  <div class="no-ticket-hint">
                    <i class="ph ph-info"></i>
                    <span>Sin caso abierto</span>
                  </div>
                }
                <div class="action-buttons">
                  @if (closeTypes().length > 0) {
                    @for (ct of closeTypes(); track ct.kpiName) {
                      <button class="action-btn" [class.primary]="$first" [class.secondary]="!$first"
                              [disabled]="!hasOpenTicket()"
                              (click)="initiateCloseTicket(ct)">
                        <i class="ph ph-check-circle"></i>
                        <span>{{ ct.name }}</span>
                      </button>
                    }
                  } @else {
                    <!-- Fallback: generic close button (no close types configured) -->
                    <button class="action-btn primary" [disabled]="!hasOpenTicket()" (click)="initiateCloseTicketGeneric()">
                      <i class="ph ph-check-circle"></i>
                      <span>Finalizar</span>
                    </button>
                  }
                </div>
              </div>

              <!-- History Section -->
              <div class="section">
                <div class="section-header">
                  <i class="ph ph-clock-counter-clockwise"></i>
                  <span>Historial de Acciones</span>
                </div>
                <div class="history-panel-inline">
                  @if (loadingHistory()) {
                    <div class="history-loading">
                      <span class="spinner-sm"></span>
                      <span>Cargando historial...</span>
                    </div>
                  } @else if (actionHistory().length > 0) {
                    <div class="history-list">
                      @for (item of actionHistory(); track item.id) {
                        <div class="history-item">
                          <div class="history-row">
                            <span class="history-user">{{ item.username }}</span>
                            <span class="history-date">{{ formatDate(item.createdAt) }}</span>
                          </div>
                          <div class="history-action">{{ formatAction(item.action) }}</div>
                          @if (item.auditedChanges && getChangesSummary(item.auditedChanges).length > 0) {
                            <div class="history-tags">
                              @for (change of getChangesSummary(item.auditedChanges); track change) {
                                <span class="history-tag">{{ change }}</span>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  } @else {
                    <div class="history-empty">
                      <i class="ph ph-clock"></i>
                      <span>Sin historial de acciones</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Ticket Close Confirmation Modal -->
  @if (showTicketConfirmation()) {
    <div class="modal-overlay" (click)="cancelCloseTicket()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <i class="ph ph-warning-circle"></i>
          <h4>Confirmar Cierre</h4>
        </div>
        <p class="modal-body">
          Se cerrara el caso como: <strong>{{ showTicketConfirmation()?.name }}</strong>
        </p>
        <div class="modal-footer">
          <button class="modal-btn cancel" (click)="cancelCloseTicket()">
            Cancelar
          </button>
          <button
            class="modal-btn confirm"
            [disabled]="isClosingTicket()"
            (click)="confirmCloseTicket()"
          >
            @if (isClosingTicket()) {
              <span class="spinner-sm"></span>
              Cerrando...
            } @else {
              Confirmar
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
