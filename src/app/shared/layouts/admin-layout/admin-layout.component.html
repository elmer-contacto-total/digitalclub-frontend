<!-- Admin Layout - PARIDAD: Rails admin.html.erb -->
<div class="admin-layout" [class.sidebar-collapsed]="sidebarCollapsed()" [class.whatsapp-visible]="whatsappVisible()" [class.impersonation-active]="isImpersonating()">
  <!-- Update Banner - Shows when app update is available -->
  <app-update-banner />

  <!-- Impersonation Toolbar - PARIDAD: Rails _admin_login_as_toolbar.html.erb -->
  <app-impersonation-toolbar />

  <!-- Sidebar -->
  <app-sidebar
    [collapsed]="sidebarCollapsed()"
    [mobileOpen]="sidebarMobileOpen()"
    (close)="closeMobileSidebar()"
    (toggleCollapse)="toggleSidebarCollapse()"
  />

  <!-- Main wrapper -->
  <div class="main-wrapper">
    <!-- Header -->
    <app-header (toggleSidebar)="toggleSidebar()" />

    <!-- Main content -->
    <main class="main-content">
      <router-outlet />
    </main>

    <!-- Footer -->
    <footer class="main-footer">
      <div class="footer-left">
        <span>Monitor WhatsApp Service &copy; {{ currentYear }}</span>
      </div>
      <div class="footer-right">
        <a href="/help" class="footer-link">Ayuda</a>
        <span class="footer-divider">|</span>
        <a href="/privacy" class="footer-link">Privacidad</a>
        <span class="footer-divider">|</span>
        <a href="/terms" class="footer-link">Términos</a>
      </div>
    </footer>
  </div>

  <!-- Bulk Send Overlay - blocks ALL interaction during mass sending -->
  @if (bulkSendActive()) {
    <div class="bulk-send-overlay">
      <div class="bulk-send-card">
        @if (bulkSendState().state === 'running') {
          <div class="bulk-send-icon"><i class="ph ph-paper-plane-tilt"></i></div>
          <h3>Envío masivo en curso</h3>
          <p class="bulk-send-phone">{{ bulkSendState().currentPhone || 'Preparando...' }}</p>
        } @else if (bulkSendState().state === 'completed') {
          <div class="bulk-send-icon bulk-send-icon-success"><i class="ph ph-check-circle"></i></div>
          <h3>Envío completado</h3>
          <p class="bulk-send-phone">{{ bulkSendState().sentCount }} de {{ bulkSendState().totalRecipients }} enviados</p>
        } @else if (bulkSendState().state === 'cancelled') {
          <div class="bulk-send-icon bulk-send-icon-cancel"><i class="ph ph-x-circle"></i></div>
          <h3>Envío cancelado</h3>
          <p class="bulk-send-phone">{{ bulkSendState().sentCount }} de {{ bulkSendState().totalRecipients }} enviados</p>
        } @else if (bulkSendState().state === 'pausing') {
          <div class="bulk-send-icon"><i class="ph ph-hourglass"></i></div>
          <h3>Pausando envío...</h3>
          <p class="bulk-send-phone">Esperando que termine el mensaje actual</p>
        } @else {
          <div class="bulk-send-icon"><i class="ph ph-paper-plane-tilt"></i></div>
          <h3>Envío masivo pausado</h3>
          <p class="bulk-send-phone">En espera</p>
        }
        <div class="bulk-send-progress-bar">
          <div class="bulk-send-progress-fill" [style.width.%]="bulkSendProgress"></div>
        </div>
        <p class="bulk-send-count">
          {{ bulkSendState().sentCount }} / {{ bulkSendState().totalRecipients }} enviados
          @if (bulkSendState().failedCount > 0) {
            <span class="bulk-send-failed">({{ bulkSendState().failedCount }} fallidos)</span>
          }
        </p>
        @if (bulkSendState().state === 'running') {
          <div class="bulk-send-actions">
            <button class="bulk-send-btn bulk-send-btn-pause" (click)="pauseBulkSend()">
              <i class="ph ph-pause"></i> Pausar
            </button>
          </div>
        } @else if (bulkSendState().state === 'paused') {
          <div class="bulk-send-actions">
            <button class="bulk-send-btn bulk-send-btn-resume" (click)="dismissBulkSendOverlay()">
              <i class="ph ph-x-circle"></i> Cerrar
            </button>
          </div>
        }
        @if (bulkSendState().state === 'completed' || bulkSendState().state === 'cancelled') {
          <p class="bulk-send-notice">Cerrando en unos segundos...</p>
        } @else if (bulkSendState().state === 'paused') {
          <p class="bulk-send-notice">Para reanudar, ve a <strong>Envíos Masivos</strong></p>
        } @else {
          <p class="bulk-send-notice">La interfaz está bloqueada durante el envío masivo</p>
        }
      </div>
    </div>
  }

  <!-- Periodic Pause Bubble -->
  @if (periodicPauseBubbleActive()) {
    <div class="ppb" [ngStyle]="bubbleStyle"
         (mousedown)="onBubbleMouseDown($event)">
      <div class="ppb-header">
        <div class="ppb-timer-group">
          <span class="ppb-pulse"></span>
          <span class="ppb-timer">{{ periodicPauseCountdown() }}</span>
        </div>
        <span class="ppb-label">Pausa anti-ban</span>
      </div>
      <div class="ppb-progress">
        <div class="ppb-progress-bar">
          <div class="ppb-progress-fill" [style.width.%]="bubbleSendProgress"></div>
        </div>
        <span class="ppb-progress-text">{{ bulkSendState().sentCount }}/{{ bulkSendState().totalRecipients }} enviados</span>
      </div>
      <div class="ppb-actions">
        <button class="ppb-btn ppb-btn-pause" (click)="pauseFromBubble()" title="Pausar permanentemente">
          <i class="ph ph-pause"></i> Pausar
        </button>
        <button class="ppb-btn ppb-btn-cancel" (click)="cancelFromBubble()" title="Cancelar envío">
          <i class="ph ph-x"></i> Cancelar
        </button>
      </div>
    </div>
  }

  <!-- Toast Container -->
  <div class="toast-container">
    @for (toast of toasts(); track toast.id) {
      <div class="toast toast-{{ toast.type }}" (click)="dismissToast(toast.id)">
        <i class="ph {{ getToastIcon(toast.type) }}"></i>
        <span>{{ toast.message }}</span>
        <button type="button" class="toast-close" aria-label="Cerrar">
          <i class="ph ph-x"></i>
        </button>
      </div>
    }
  </div>
</div>
